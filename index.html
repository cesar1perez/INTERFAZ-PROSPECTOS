<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROSPECCI√ìN LLANTERAMA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root { --marino: #001f3f; --mostaza: #FFB800; }
        body { font-family: 'Arial Black', sans-serif; background: #f1f5f9; color: #000; overflow-x: hidden; }
        
        .home-container { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--marino); position: fixed; width: 100%; z-index: 1000; }
        .logo-ll { width: 110px; height: 110px; border: 6px solid var(--mostaza); display: flex; align-items: center; justify-content: center; border-radius: 25px; }
        .logo-ll span { color: var(--mostaza); font-size: 65px; font-style: italic; font-weight: 900; }
        
        .btn-main { background: white; border: 4px solid var(--marino); padding: 18px; border-radius: 15px; width: 290px; display: flex; flex-direction: column; align-items: center; margin-bottom: 12px; box-shadow: 0 6px 0 #000; transition: 0.1s; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 #000; }
        .btn-main span { color: var(--marino); font-size: 14px; font-weight: 900; margin-top: 5px; text-transform: uppercase; }

        .view-section { display: none; min-height: 100vh; background: #f1f5f9; }
        .active-view { display: block !important; }
        .header-app { background: var(--marino); color: white; padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 4px solid var(--mostaza); position: sticky; top: 0; z-index: 500; }

        .leaflet-popup-content-wrapper { background: white; border-radius: 12px; border: 2px solid var(--marino); }
        .popup-title { font-size: 12px; font-weight: 900; color: var(--marino); text-transform: uppercase; margin-bottom: 2px; text-align: center; }
        .popup-vendedor { font-size: 10px; font-weight: bold; color: #64748b; text-align: center; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 4px; }

        .map-layout { display: flex; height: calc(100vh - 65px); position: relative; }
        @media (max-width: 768px) {
            .sidebar-map { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; z-index: 1000; transform: translateY(100%); transition: 0.4s; border-top: 5px solid var(--mostaza); }
            .sidebar-map.open { transform: translateY(0); }
            .btn-toggle-list { display: block !important; }
        }
        .sidebar-map { width: 320px; background: white; border-right: 4px solid var(--marino); overflow-y: auto; }
        #map { flex-grow: 1; z-index: 10; }
        
        .btn-toggle-list { 
            display: none; 
            position: absolute; 
            top: 15px; 
            left: 15px; 
            z-index: 1100; 
            background: var(--marino); 
            color: var(--mostaza); 
            padding: 10px 20px; 
            border-radius: 12px; 
            font-weight: 900; 
            border: 3px solid var(--mostaza); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            font-size: 12px;
        }

        #detailPanel { position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 450px; background: white; z-index: 2000; transform: translateX(100%); transition: 0.4s; border-left: 10px solid var(--mostaza); box-shadow: -10px 0 40px rgba(0,0,0,0.4); }
        .panel-open { transform: translateX(0) !important; }
        .field-card { border-bottom: 1px solid #eee; padding: 6px 0; }
        .badge-count { background: #2563eb; color: white; padding: 10px 20px; border-radius: 50px; font-size: 24px; box-shadow: 0 4px 0 #1e40af; }

        .btn-google-maps { background: #4285F4; color: white; padding: 6px 10px; border-radius: 5px; font-size: 10px; display: inline-flex; align-items: center; gap: 4px; cursor: pointer; border: none; font-weight: 900; }
    </style>
</head>
<body>

    <section id="homeView" class="home-container">
        <div class="logo-ll mb-8"><span>LL</span></div>
        <h1 class="text-white text-3xl font-black italic mb-10 tracking-tighter uppercase text-center">Prospecci√≥n Llanterama</h1>
        <button onclick="switchView('money')" class="btn-main"><i class="fas fa-hand-holding-usd text-3xl text-emerald-600"></i><span>Bonificaciones por mes</span></button>
        <button onclick="switchView('list')" class="btn-main"><i class="fas fa-clipboard-list text-3xl text-blue-600"></i><span>Listado y Estatus</span></button>
        <button onclick="switchView('map')" class="btn-main"><i class="fas fa-map-marked-alt text-3xl text-orange-600"></i><span>Mapa por Zonas</span></button>
    </section>

    <section id="moneyView" class="view-section">
        <div class="header-app">
            <button onclick="switchView('home')" class="bg-mostaza text-marino px-4 py-2 rounded-lg font-black text-xs">INICIO</button>
            <span class="font-black italic uppercase">Bonificaciones por Mes</span>
        </div>
        <div id="comisionesContainer" class="p-4 space-y-6"></div>
    </section>

    <section id="listView" class="view-section">
        <div class="header-app">
            <button onclick="switchView('home')" class="bg-mostaza text-marino px-4 py-2 rounded-lg font-black text-xs">INICIO</button>
            <span class="font-black italic uppercase text-xs">Listado Prospecci√≥n Llanterama</span>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar por negocio, impulsor o zona..." onkeyup="filterTable()">
        </div>
        <div class="overflow-x-auto p-2">
            <table class="w-full bg-white border-2 border-marino">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Fecha</th>
                        <th onclick="sortTable(1)">Negocio</th>
                        <th onclick="sortTable(2)">Impulsor</th>
                        <th onclick="sortTable(3)">Estatus</th>
                        <th onclick="sortTable(4)">Zona</th>
                        <th onclick="sortTable(5)">Inter√©s</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </section>

    <section id="mapView" class="view-section">
        <div class="header-app">
            <button onclick="switchView('home')" class="bg-mostaza text-marino px-4 py-2 rounded-lg font-black text-xs">INICIO</button>
            <span class="font-black italic uppercase">Mapa de Ruta</span>
        </div>
        <div class="map-layout">
            <button class="btn-toggle-list" onclick="toggleMapList()"><i class="fas fa-list"></i> VER LISTA</button>
            <div class="sidebar-map" id="mapListContainer"></div>
            <div id="map"></div>
        </div>
    </section>

    <div id="detailPanel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center border-b-4 border-marino pb-2 mb-4">
                <span class="font-black text-marino italic text-xl uppercase">Ficha T√©cnica</span>
                <button onclick="closeDetail()" class="text-4xl font-bold text-marino">√ó</button>
            </div>
            <div id="detailContent" class="overflow-y-auto flex-1 pr-2"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcrymfUz61DDQ0fK90mTNnTqKHDwOm-UxSd9uUR6ZBjhCvcS6y2_xb7BF7uQtfIsWVsFcWAHvX-x8G/pub?gid=866211599&single=true&output=csv';
        let allData = [], map, markersLayer, sortDir = {};

        function getVal(row, name) {
            const key = Object.keys(row).find(k => k.toLowerCase().trim().includes(name.toLowerCase().trim()));
            return key ? row[key].toString().trim() : "";
        }

        // FUNCI√ìN CLAVE: Limpia coordenadas para que el mapa no falle
        function cleanCoords(gpsStr) {
            if(!gpsStr) return null;
            const parts = gpsStr.split(',');
            if(parts.length < 2) return null;
            const lat = parseFloat(parts[0].replace(/[^-0.9.]/g, ''));
            const lng = parseFloat(parts[1].replace(/[^-0.9.]/g, ''));
            return (isNaN(lat) || isNaN(lng)) ? null : [lat, lng];
        }

        function switchView(v) {
            document.getElementById('homeView').style.display = (v === 'home') ? 'flex' : 'none';
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view'));
            if(v !== 'home') document.getElementById(v + 'View').classList.add('active-view');
            if(v === 'map') { if(!map) initMap(); setTimeout(() => map.invalidateSize(), 300); }
            window.scrollTo(0,0);
        }

        function toggleMapList() {
            document.querySelector('.sidebar-map').classList.toggle('open');
            const btn = document.querySelector('.btn-toggle-list');
            btn.innerHTML = btn.innerHTML.includes('VER') ? '<i class="fas fa-times"></i> CERRAR' : '<i class="fas fa-list"></i> VER LISTA';
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: function(res) {
                    allData = res.data.filter(r => r['Marca temporal']);
                    renderAll();
                }
            });
        }

        function renderAll() {
            renderBonificaciones();
            renderListado(allData);
            if(map) renderMapa();
        }

        function renderBonificaciones() {
            const container = document.getElementById('comisionesContainer');
            container.innerHTML = '';
            const meses = ["Enero", "Febrero", "Marzo"];
            const impulsores = ["Marco A. Hern√°ndez", "Josue Jim√°rez"];
            meses.forEach(mes => {
                let html = `<div class="bg-marino text-mostaza p-2 font-black text-center rounded shadow uppercase italic tracking-widest">${mes}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 mb-8">`;
                impulsores.forEach(imp => {
                    const filtrados = allData.filter(r => getVal(r, "Impulsor de mercado") === imp && getVal(r, "Mes correspondiente").toLowerCase().includes(mes.toLowerCase()));
                    html += `<div class="bg-white p-6 border-l-[10px] border-marino rounded-2xl shadow-lg flex justify-between items-center"><div><p class="text-[10px] text-slate-400 font-bold uppercase mb-2 italic">${imp}</p><p class="text-4xl font-black text-emerald-600">$${filtrados.length * 20}</p></div><div class="flex flex-col items-center"><div class="badge-count font-black">${filtrados.length}</div><p class="text-[10px] font-black mt-2 text-blue-700 uppercase">Hechos</p></div></div>`;
                });
                container.innerHTML += html + `</div>`;
            });
        }

        function renderListado(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            data.forEach((row) => {
                const tr = document.createElement('tr');
                tr.className = "text-[11px] font-bold border-b active:bg-yellow-50";
                tr.onclick = () => showDetail(allData.indexOf(row));
                tr.innerHTML = `
                    <td class="p-3 border">${row['Marca temporal'] ? row['Marca temporal'].split(' ')[0] : '-'}</td>
                    <td class="p-3 border text-marino uppercase font-black">${getVal(row, "Nombre del negocio")}</td>
                    <td class="p-3 border uppercase text-blue-700">${getVal(row, "Impulsor de mercado")}</td>
                    <td class="p-3 border">${getVal(row, "ESTATUS") || 'S/D'}</td>
                    <td class="p-3 border uppercase text-slate-500">${getVal(row, "Zona")}</td>
                    <td class="p-3 border italic">${getVal(row, "inter√©s")}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(r => Object.values(r).some(v => v.toString().toLowerCase().includes(term)));
            renderListado(filtered);
        }

        function sortTable(idx) {
            sortDir[idx] = !sortDir[idx];
            const keys = ["Marca temporal", "Nombre del negocio", "Impulsor de mercado", "ESTATUS", "Zona", "inter√©s"];
            const sorted = [...allData].sort((a, b) => {
                let v1 = getVal(a, keys[idx]), v2 = getVal(b, keys[idx]);
                return sortDir[idx] ? v1.localeCompare(v2) : v2.localeCompare(v1);
            });
            renderListado(sorted);
        }

        function showDetail(i) {
            const r = allData[i];
            const content = document.getElementById('detailContent');
            const gps = getVal(r, "GPS");
            const campos = ["Impulsor de mercado", "Dia de visita", "Zona", "Nombre del negocio", "Nombre del encargado / Due√±o", "Direcci√≥n completa.", "Giro del negocio", "Tel√©fono", "Correo electr√≥nico", "¬øCompra acumuladores?", "¬øQu√© marca de acumuladores?", "¬øCompra lubricantes?", "¬øQu√© marca de lubricante?", "¬øCompra motobater√≠as?", "¬øQu√© marca de motobater√≠a?", "¬øCompra filtros?", "¬øQu√© marca de filtros?", "¬øCompra llanta?", "¬øQu√© marca de llanta?", "Observaciones / Informaci√≥n adicional.", "¬øQu√© nivel de inter√©s mostr√≥ el cliente?", "¬øLe distribuye la competencia?", "ESTATUS", "VISITAS"];
            let html = campos.map(c => `<div class="field-card"><p class="text-[9px] text-slate-400 font-black uppercase">${c}</p><p class="text-[13px] font-black text-marino leading-none">${getVal(r, c) || '---'}</p></div>`).join('');
            if(gps) html = `<button onclick="openInGoogleMaps('${gps}')" class="btn-google-maps w-full justify-center py-3 mb-4"><i class="fas fa-directions text-lg"></i> IR AL CLIENTE CON GPS</button>` + html;
            content.innerHTML = html;
            document.getElementById('detailPanel').classList.add('panel-open');
        }

        function openInGoogleMaps(gps) { window.open(`https://www.google.com/maps?q=${gps}`, '_blank'); }

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([20.10, -98.75], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            L.control.zoom({position: 'bottomright'}).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            renderMapa();
        }

        function renderMapa() {
            markersLayer.clearLayers();
            const sidebar = document.getElementById('mapListContainer');
            sidebar.innerHTML = '<div class="p-4 bg-marino text-mostaza font-black text-center text-xs border-b-2 border-mostaza">ZONAS</div>';
            
            const zonas = [...new Set(allData.map(r => getVal(r, "Zona")).filter(z => z))];
            
            zonas.forEach(z => {
                const pros = allData.filter(r => getVal(r, "Zona") === z);
                sidebar.innerHTML += `<div class="bg-slate-100 text-marino p-2 px-4 font-black text-xs uppercase border-y flex justify-between"><span>${z}</span><span class="bg-marino text-white px-2 rounded-full">${pros.length}</span></div>`;
                
                pros.forEach(row => {
                    const gpsRaw = getVal(row, "GPS");
                    const coords = cleanCoords(gpsRaw);
                    const nombre = getVal(row, "Nombre del negocio");
                    const impulsor = getVal(row, "Impulsor de mercado") || "S/A";
                    
                    if(coords) {
                        const marker = L.circleMarker(coords, { 
                            radius: 10, fillColor: "#ff0000", color: "#fff", weight: 2, fillOpacity: 1 
                        }).addTo(markersLayer);
                        
                        const popupContent = `
                            <div class="p-1">
                                <div class="popup-title">${nombre}</div>
                                <div class="popup-vendedor">Resp: ${impulsor}</div>
                                <button onclick="openInGoogleMaps('${gpsRaw}')" class="btn-google-maps w-full justify-center">
                                    <i class="fas fa-location-arrow"></i> IR AHORA
                                </button>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                    }
                    
                    sidebar.innerHTML += `
                    <div class="p-3 px-6 border-b flex justify-between items-center">
                        <div class="text-[10px] font-black uppercase text-slate-600 cursor-pointer" onclick="focusOnMap('${gpsRaw}')">${nombre}</div>
                        ${gpsRaw ? `<button onclick="openInGoogleMaps('${gpsRaw}')" class="btn-google-maps"><i class="fas fa-location-arrow"></i> IR</button>` : ''}
                    </div>`;
                });
            });
        }

        function focusOnMap(gps) {
            const coords = cleanCoords(gps);
            if(!coords) return;
            map.flyTo(coords, 16);
            if(window.innerWidth <= 768) toggleMapList();
        }

        function closeDetail() { document.getElementById('detailPanel').classList.remove('panel-open'); }
        window.onload = loadData;
    </script>
</body>
</html>
