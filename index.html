<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hidalgo CRM - Mapa Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root { --azul-marino: #001f3f; --amarillo-mostaza: #FFB800; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        .bg-marino { background-color: var(--azul-marino); }
        .text-mostaza { color: var(--amarillo-mostaza); }
        .view-section { display: none; height: calc(100vh - 80px); }
        .active-view { display: flex !important; }
        #map { flex-grow: 1; height: 100%; border-radius: 0 12px 12px 0; }
        .sidebar-map { width: 320px; background: white; border-right: 1px solid #e2e8f0; overflow-y: auto; }
        .item-mapa { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .item-mapa:hover { background-color: #fffbeb; border-left: 4px solid var(--amarillo-mostaza); }
    </style>
</head>
<body>

    <div class="flex h-screen">
        <aside class="w-20 bg-marino text-white flex flex-col items-center py-6 shadow-2xl z-50">
            <div class="mb-10 text-mostaza text-2xl font-black italic">H</div>
            <nav class="space-y-8">
                <button onclick="switchView('list')" title="Lista" class="text-xl hover:text-mostaza transition"><i class="fas fa-table-list"></i></button>
                <button onclick="switchView('map')" title="Mapa" class="text-xl hover:text-mostaza transition"><i class="fas fa-map-location-dot"></i></button>
                <button onclick="loadData()" title="Recargar" class="text-xl hover:text-mostaza transition"><i class="fas fa-sync-alt"></i></button>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="h-20 bg-white border-b flex items-center justify-between px-8">
                <div>
                    <h2 id="viewTitle" class="text-xl font-black text-marino uppercase">Panel de Control</h2>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-xs font-bold text-slate-400 uppercase">Estatus: Conectado</span>
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                </div>
            </header>

            <div id="listView" class="view-section active-view p-6">
                <div class="w-full bg-white rounded-xl shadow-sm border overflow-hidden overflow-y-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-marino text-xs uppercase font-black sticky top-0">
                            <tr>
                                <th class="p-4">Negocio / Encargado</th>
                                <th class="p-4">Zona</th>
                                <th class="p-4">Interés</th>
                                <th class="p-4 text-center">Visitas</th>
                                <th class="p-4">Estatus</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div id="mapView" class="view-section overflow-hidden">
                <div class="sidebar-map" id="mapList">
                    <div class="p-4 bg-slate-50 border-b">
                        <input type="text" id="searchMap" placeholder="Buscar negocio..." class="w-full p-2 text-sm border rounded-lg focus:ring-2 focus:ring-mostaza outline-none">
                    </div>
                    <div id="mapItemsContainer"></div>
                </div>
                <div id="map"></div>
            </div>
        </div>

        <div id="detailPanel" class="fixed top-0 right-0 w-96 h-full bg-white shadow-2xl translate-x-full transition-transform duration-300 z-[100] border-l-4 border-mostaza overflow-y-auto">
            <div class="p-6 bg-marino text-white flex justify-between items-center">
                <h3 class="font-bold text-mostaza uppercase text-sm italic">Ficha Técnica</h3>
                <button onclick="closeDetail()" class="text-white text-3xl">&times;</button>
            </div>
            <div id="detailContent" class="p-6 space-y-6"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcrymfUz61DDQ0fK90mTNnTqKHDwOm-UxSd9uUR6ZBjhCvcS6y2_xb7BF7uQtfIsWVsFcWAHvX-x8G/pub?gid=866211599&single=true&output=csv';
        let allData = [], map, markersLayer, markerObjects = {};

        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view'));
            document.getElementById(v + 'View').classList.add('active-view');
            document.getElementById('viewTitle').innerText = v === 'list' ? 'Listado de Prospectos' : 'Mapa Interactivo de Ruta';
            if(v === 'map' && map) setTimeout(() => map.invalidateSize(), 300);
        }

        function getVal(row, kw) {
            const key = Object.keys(row).find(k => k.toLowerCase().includes(kw.toLowerCase()));
            return key ? row[key] : "";
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: function(r) { allData = r.data.filter(f => f['Marca temporal']); render(); }
            });
        }

        function zoomTo(id) {
            const m = markerObjects[id];
            if(m) {
                map.flyTo(m.getLatLng(), 18, { duration: 1.5 });
                setTimeout(() => m.openPopup(), 1600);
            }
        }

        function render() {
            const tbody = document.getElementById('tableBody');
            const mapItems = document.getElementById('mapItemsContainer');
            tbody.innerHTML = ''; mapItems.innerHTML = '';
            
            if(!map) {
                map = L.map('map').setView([20.10, -98.75], 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                markersLayer = L.layerGroup().addTo(map);
            }
            markersLayer.clearLayers(); markerObjects = {};

            allData.forEach((row, i) => {
                const negocio = getVal(row, 'Nombre del negocio') || getVal(row, 'encargado') || "Sin Nombre";
                const zona = getVal(row, 'Zona');
                const gps = getVal(row, 'GPS');
                const estatus = getVal(row, 'Estatus') || 'Nuevo';

                // Render Tabla
                tbody.innerHTML += `
                    <tr onclick="showDetail(${i})" class="hover:bg-slate-50 cursor-pointer">
                        <td class="p-4"><b>${negocio}</b><br><span class="text-[10px] text-slate-400">${getVal(row, 'encargado')}</span></td>
                        <td class="p-4 text-slate-600">${zona}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-[10px] font-black ${getVal(row, 'interés').includes('Alto') ? 'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'} uppercase">${getVal(row, 'interés')}</span></td>
                        <td class="p-4 text-center font-bold">${getVal(row, 'Visitas') || '1'}</td>
                        <td class="p-4 font-black text-marino text-xs uppercase">${estatus}</td>
                    </tr>`;

                // Render Lista Mapa y Marcador
                if(gps && gps.includes(',')) {
                    const c = gps.replace(/[^\d.,-]/g, '').split(',').map(parseFloat);
                    if(!isNaN(c[0])) {
                        const m = L.marker([c[0], c[1]]).addTo(markersLayer).bindPopup(`<b>${negocio}</b><br>${zona}`);
                        markerObjects[i] = m;

                        mapItems.innerHTML += `
                            <div class="item-mapa" onclick="zoomTo(${i})">
                                <div class="text-xs font-black text-marino uppercase">${negocio}</div>
                                <div class="text-[10px] text-slate-400">${zona}</div>
                                <div class="text-[9px] mt-1 font-bold text-mostaza uppercase">${estatus}</div>
                            </div>`;
                    }
                }
            });
        }

        function showDetail(i) {
            const r = allData[i];
            const content = document.getElementById('detailContent');
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="text-2xl font-black text-marino uppercase">${getVal(r, 'negocio') || getVal(r, 'encargado')}</h4>
                    <span class="bg-mostaza text-marino px-2 py-1 text-[10px] font-black rounded uppercase">${getVal(r, 'Estatus') || 'Nuevo'}</span>
                </div>
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div class="bg-slate-50 p-3 rounded"><b>VISITAS</b><br><span class="text-lg font-black">${getVal(r, 'Visitas') || 1}</span></div>
                    <div class="bg-slate-50 p-3 rounded"><b>ZONA</b><br><span class="text-sm font-bold">${getVal(r, 'Zona')}</span></div>
                </div>
                <div class="space-y-2 text-sm border-t pt-4">
                    <p><b>Baterías:</b> ${getVal(r, 'marca de acumuladores') || 'No'}</p>
                    <p><b>Aceites:</b> ${getVal(r, 'marca de lubricante') || 'No'}</p>
                    <p><b>Moto:</b> ${getVal(r, 'marca de motobatería') || 'No'}</p>
                    <p><b>Filtros:</b> ${getVal(r, 'marca de filtros') || 'No'}</p>
                </div>
                <div class="bg-marino text-white p-4 rounded-xl text-xs italic">"${getVal(r, 'Observaciones') || 'Sin notas.'}"</div>
                <button onclick="switchView('map'); setTimeout(() => zoomTo(${i}), 500);" class="w-full bg-slate-100 hover:bg-mostaza p-3 rounded-lg font-black text-marino transition">
                    <i class="fas fa-location-crosshairs mr-2"></i> LOCALIZAR EN MAPA
                </button>
            `;
            document.getElementById('detailPanel').classList.remove('translate-x-full');
        }

        function closeDetail() { document.getElementById('detailPanel').classList.add('translate-x-full'); }
        window.onload = loadData;
    </script>
</body>
</html>
