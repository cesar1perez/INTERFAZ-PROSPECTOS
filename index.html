<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Prospectos - Refaccionarias Hidalgo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .view-section { display: none; }
        .active-view { display: block; }
        #map { height: 600px; width: 100%; border-radius: 12px; z-index: 1; }
        .glass { background: white; border: 1px solid #e2e8f0; border-radius: 12px; }
    </style>
</head>
<body>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-xl font-bold text-blue-400">Impulso <span class="text-white">Hidalgo</span></h1>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="switchView('list')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-800 rounded-lg transition">
                    <i class="fas fa-table text-blue-400"></i> Tabla de Datos
                </button>
                <button onclick="switchView('map')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-800 rounded-lg transition">
                    <i class="fas fa-map-location-dot text-green-400"></i> Mapa de Ruta
                </button>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b p-4 flex justify-between items-center">
                <h2 id="viewTitle" class="text-lg font-bold text-slate-700">Listado de Prospectos</h2>
                <button onclick="loadData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition">
                    <i class="fas fa-sync-alt mr-2"></i> Refrescar Datos
                </button>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="glass p-5">
                        <p class="text-slate-500 text-sm uppercase font-bold tracking-wider">Total Prospectos</p>
                        <h3 class="text-3xl font-black text-slate-800" id="statTotal">0</h3>
                    </div>
                    <div class="glass p-5 border-l-4 border-orange-500">
                        <p class="text-slate-500 text-sm uppercase font-bold tracking-wider">Inter√©s Alto üî•</p>
                        <h3 class="text-3xl font-black text-slate-800" id="statHigh">0</h3>
                    </div>
                    <div class="glass p-5 border-l-4 border-blue-500">
                        <p class="text-slate-500 text-sm uppercase font-bold tracking-wider">Zonas Visitadas</p>
                        <h3 class="text-3xl font-black text-slate-800" id="statZones">0</h3>
                    </div>
                </div>

                <div id="listView" class="view-section active-view">
                    <div class="glass overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b">
                                <tr class="text-slate-600 text-xs uppercase font-bold">
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Negocio</th>
                                    <th class="p-4">Zona</th>
                                    <th class="p-4">Inter√©s</th>
                                    <th class="p-4">Coordenadas</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-sm divide-y">
                                <tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Esperando datos reales del Google Sheet...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="mapView" class="view-section">
                    <div id="map" class="shadow-inner border bg-slate-100"></div>
                </div>

            </main>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcrymfUz61DDQ0fK90mTNnTqKHDwOm-UxSd9uUR6ZBjhCvcS6y2_xb7BF7uQtfIsWVsFcWAHvX-x8G/pub?gid=866211599&single=true&output=csv';
        
        let map;
        let markersLayer = L.layerGroup();
        let allData = [];

        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById(view + 'View').classList.add('active-view');
            document.getElementById('viewTitle').innerText = view === 'list' ? 'Listado de Prospectos' : 'Mapa de Ruta Geogr√°fico';
            if(view === 'map') {
                setTimeout(() => {
                    if(!map) initMap();
                    map.invalidateSize();
                }, 200);
            }
        }

        function initMap() {
            map = L.map('map').setView([20.1011, -98.7591], 9);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            markersLayer.addTo(map);
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    processData(results.data);
                }
            });
        }

        function processData(data) {
            // Filtrar solo filas que tengan contenido real
            allData = data.filter(row => row['Marca temporal']);
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            markersLayer.clearLayers();

            let countHigh = 0;
            let zones = new Set();

            allData.forEach(row => {
                // Ajustar nombres de columnas seg√∫n tu Formulario
                const nombre = row['Nombre de la Refaccionaria'] || row['Nombre del Negocio'] || 'S/N';
                const zona = row['Zona'] || 'Sin Zona';
                const interes = row['Nivel de Inter√©s'] || 'Medio';
                const gps = row['Ubicaci√≥n GPS'] || row['Coordenadas'] || '';
                const fecha = row['Marca temporal'].split(' ')[0];

                zones.add(zona);
                if(interes.toLowerCase().includes('alto')) countHigh++;

                // L√≥gica de Tabla
                let badgeColor = interes.toLowerCase().includes('alto') ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-600';
                
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-4 text-slate-500">${fecha}</td>
                        <td class="p-4 font-bold text-slate-800">${nombre}</td>
                        <td class="p-4 text-slate-600">${zona}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeColor}">${interes}</span></td>
                        <td class="p-4 font-mono text-xs text-blue-500">${gps}</td>
                    </tr>
                `;

                // L√≥gica de Mapa
                if(gps.includes(',')) {
                    const coords = gps.split(',').map(c => parseFloat(c.trim()));
                    if(!isNaN(coords[0]) && !isNaN(coords[1])) {
                        const marker = L.marker([coords[0], coords[1]])
                            .bindPopup(`<b>${nombre}</b><br>Zona: ${zona}<br>Inter√©s: ${interes}`);
                        markersLayer.addLayer(marker);
                    }
                }
            });

            // Actualizar Contadores
            document.getElementById('statTotal').innerText = allData.length;
            document.getElementById('statHigh').innerText = countHigh;
            document.getElementById('statZones').innerText = zones.size;

            if(allData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">No hay datos todav√≠a. Env√≠a un formulario de prueba.</td></tr>';
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
