<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLANTERAMA CRM - V3.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root { --marino: #001f3f; --mostaza: #FFB800; }
        body { font-family: 'Arial Black', sans-serif; background: #f1f5f9; color: #000; overflow-x: hidden; }
        
        .home-container { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--marino); position: fixed; width: 100%; z-index: 1000; }
        .logo-ll { width: 110px; height: 110px; border: 6px solid var(--mostaza); display: flex; align-items: center; justify-content: center; border-radius: 25px; }
        .logo-ll span { color: var(--mostaza); font-size: 65px; font-style: italic; font-weight: 900; }
        
        .btn-main { background: white; border: 4px solid var(--marino); padding: 18px; border-radius: 15px; width: 290px; display: flex; flex-direction: column; align-items: center; margin-bottom: 12px; box-shadow: 0 6px 0 #000; }
        
        .view-section { display: none; min-height: 100vh; background: #f1f5f9; }
        .active-view { display: block !important; }
        .header-app { background: var(--marino); color: white; padding: 15px; display: flex; align-items: center; gap: 15px; border-bottom: 4px solid var(--mostaza); position: sticky; top: 0; z-index: 500; }

        /* Mapa y Sidebar Adaptable */
        .map-layout { display: flex; height: calc(100vh - 65px); position: relative; }
        
        @media (max-width: 768px) {
            .sidebar-map { 
                position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; 
                z-index: 1000; transform: translateY(100%); transition: 0.4s; 
                border-top: 5px solid var(--mostaza); border-right: none !important;
            }
            .sidebar-map.open { transform: translateY(0); }
            .btn-toggle-list { display: block !important; }
        }

        .sidebar-map { width: 320px; background: white; border-right: 4px solid var(--marino); overflow-y: auto; }
        #map { flex-grow: 1; z-index: 10; }
        .btn-toggle-list { display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1100; background: var(--marino); color: var(--mostaza); padding: 12px 24px; border-radius: 30px; font-weight: 900; border: 2px solid var(--mostaza); box-shadow: 0 4px 15px rgba(0,0,0,0.4); }

        /* Estilos de Comisiones */
        .badge-count { background: #2563eb; color: white; padding: 10px 20px; border-radius: 50px; font-size: 24px; box-shadow: 0 4px 0 #1e40af; }

        /* Ficha Lateral */
        #detailPanel { position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 450px; background: white; z-index: 2000; transform: translateX(100%); transition: 0.4s; border-left: 10px solid var(--mostaza); box-shadow: -10px 0 40px rgba(0,0,0,0.4); }
        .panel-open { transform: translateX(0) !important; }
        .field-card { border-bottom: 1px solid #eee; padding: 6px 0; }
    </style>
</head>
<body>

    <section id="homeView" class="home-container">
        <div class="logo-ll mb-8"><span>LL</span></div>
        <h1 class="text-white text-3xl font-black italic mb-10 tracking-tighter">CRM ESTRATÉGICO</h1>
        <button onclick="switchView('money')" class="btn-main"><i class="fas fa-hand-holding-usd text-3xl text-emerald-600"></i><span class="font-black text-marino">COMISIONES POR MES</span></button>
        <button onclick="switchView('list')" class="btn-main"><i class="fas fa-clipboard-list text-3xl text-blue-600"></i><span class="font-black text-marino">LISTADO Y ESTATUS</span></button>
        <button onclick="switchView('map')" class="btn-main"><i class="fas fa-map-marked-alt text-3xl text-orange-600"></i><span class="font-black text-marino">MAPA POR ZONAS</span></button>
    </section>

    <section id="moneyView" class="view-section">
        <div class="header-app">
            <button onclick="switchView('home')" class="bg-mostaza text-marino px-4 py-2 rounded-lg font-black text-xs">INICIO</button>
            <span class="font-black italic uppercase">Cálculo de Comisiones</span>
        </div>
        <div id="comisionesContainer" class="p-4 space-y-6"></div>
    </section>

    <section id="listView" class="view-section">
        <div class="header-app">
            <button onclick="switchView('home')" class="bg-mostaza text-marino px-4 py-2 rounded-lg font-black text-xs">INICIO</button>
            <span class="font-black italic uppercase">Base de Prospectos</span>
        </div>
        <div class="overflow-x-auto p-2">
            <table class="w-full bg-white border-2 border-marino">
                <thead>
                    <tr class="bg-marino text-mostaza text-[10px]">
                        <th class="p-2 border">FECHA</th>
                        <th class="p-2 border">NEGOCIO</th>
                        <th class="p-2 border">COMPETENCIA</th>
                        <th class="p-2 border">ESTATUS</th>
                        <th class="p-2 border">ZONA</th>
                        <th class="p-2 border">INTERÉS</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </section>

    <section id="mapView" class="view-section">
        <div class="header-app">
            <button onclick="switchView('home')" class="bg-mostaza text-marino px-4 py-2 rounded-lg font-black text-xs">INICIO</button>
            <span class="font-black italic uppercase">Mapa de Ruta</span>
        </div>
        <div class="map-layout">
            <button class="btn-toggle-list" onclick="toggleMapList()"><i class="fas fa-list"></i> VER LISTA</button>
            <div class="sidebar-map shadow-2xl" id="mapListContainer"></div>
            <div id="map"></div>
        </div>
    </section>

    <div id="detailPanel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center border-b-4 border-marino pb-2 mb-4">
                <span class="font-black text-marino italic text-xl uppercase">Ficha Prospecto</span>
                <button onclick="closeDetail()" class="text-4xl font-bold">&times;</button>
            </div>
            <div id="detailContent" class="overflow-y-auto flex-1 pr-2"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcrymfUz61DDQ0fK90mTNnTqKHDwOm-UxSd9uUR6ZBjhCvcS6y2_xb7BF7uQtfIsWVsFcWAHvX-x8G/pub?gid=866211599&single=true&output=csv';
        let allData = [], map, markersLayer;

        function getVal(row, name) {
            const key = Object.keys(row).find(k => k.toLowerCase().trim().includes(name.toLowerCase().trim()));
            return key ? row[key].toString().trim() : "";
        }

        function switchView(v) {
            document.getElementById('homeView').style.display = (v === 'home') ? 'flex' : 'none';
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view'));
            if(v !== 'home') document.getElementById(v + 'View').classList.add('active-view');
            if(v === 'map') { if(!map) initMap(); setTimeout(() => map.invalidateSize(), 300); }
            window.scrollTo(0,0);
        }

        function toggleMapList() {
            document.querySelector('.sidebar-map').classList.toggle('open');
            const btn = document.querySelector('.btn-toggle-list');
            btn.innerHTML = btn.innerHTML.includes('VER') ? '<i class="fas fa-times"></i> CERRAR LISTA' : '<i class="fas fa-list"></i> VER LISTA';
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: function(res) {
                    allData = res.data.filter(r => r['Marca temporal']);
                    renderAll();
                }
            });
        }

        function renderAll() {
            renderComisiones();
            renderListado();
            if(map) renderMapa();
        }

        function renderComisiones() {
            const container = document.getElementById('comisionesContainer');
            container.innerHTML = '';
            const meses = ["Enero", "Febrero", "Marzo"];
            const impulsores = ["Marco A. Hernández", "Josue Jimárez"];

            meses.forEach(mes => {
                let html = `<div class="bg-marino text-mostaza p-2 font-black text-center rounded shadow uppercase italic tracking-widest">${mes}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 mb-8">`;
                impulsores.forEach(imp => {
                    const filtrados = allData.filter(r => {
                        const mesSheet = getVal(r, "Mes correspondiente");
                        const impulsorSheet = getVal(r, "Impulsor de mercado");
                        return impulsorSheet === imp && mesSheet.toLowerCase().includes(mes.toLowerCase());
                    });
                    html += `
                        <div class="bg-white p-6 border-l-[10px] border-marino rounded-2xl shadow-lg flex justify-between items-center">
                            <div class="flex-1">
                                <p class="text-[10px] text-slate-400 font-bold uppercase mb-2 italic">${imp}</p>
                                <p class="text-4xl font-black text-emerald-600">$${filtrados.length * 20}</p>
                                <p class="text-[9px] font-black text-slate-500 uppercase mt-1">Ganancia Acumulada</p>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="badge-count font-black">${filtrados.length}</div>
                                <p class="text-[10px] font-black mt-2 text-blue-700">HECHOS</p>
                            </div>
                        </div>`;
                });
                container.innerHTML += html + `</div>`;
            });
        }

        function renderListado() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            allData.forEach((row, i) => {
                const comp = getVal(row, "distribuye la competencia").toLowerCase().includes("si");
                tbody.innerHTML += `
                    <tr onclick="showDetail(${i})" class="text-[11px] font-bold border-b">
                        <td class="p-2 border">${row['Marca temporal'].split(' ')[0]}</td>
                        <td class="p-2 border text-marino uppercase">${getVal(row, "Nombre del negocio")}</td>
                        <td class="p-2 border text-center ${comp ? 'text-red-500':'text-green-600'}">${comp ? 'SI' : 'NO'}</td>
                        <td class="p-2 border">${getVal(row, "ESTATUS") || 'S/D'}</td>
                        <td class="p-2 border uppercase">${getVal(row, "Zona")}</td>
                        <td class="p-2 border">${getVal(row, "interés")}</td>
                    </tr>`;
            });
        }

        function showDetail(i) {
            const r = allData[i];
            const content = document.getElementById('detailContent');
            const campos = [
                "Impulsor de mercado", "Dia de visita", "Zona", "Nombre del negocio", "Nombre del encargado / Dueño",
                "Dirección completa.", "Giro del negocio", "Teléfono", "Correo electrónico", "¿Compra acumuladores?",
                "¿Qué marca de acumuladores?", "¿Compra lubricantes?", "¿Qué marca de lubricante?", "¿Compra motobaterías?",
                "¿Qué marca de motobatería?", "¿Compra filtros?", "¿Qué marca de filtros?", "¿Compra llanta?",
                "¿Qué marca de llanta?", "Observaciones / Información adicional.", "¿Qué nivel de interés mostró el cliente?",
                "¿Le distribuye la competencia?", "ESTATUS", "VISITAS"
            ];
            let html = '';
            campos.forEach(campo => {
                html += `<div class="field-card"><p class="text-[9px] text-slate-400 font-black uppercase">${campo}</p><p class="text-[13px] font-black text-marino leading-none">${getVal(r, campo) || '---'}</p></div>`;
            });
            content.innerHTML = html;
            document.getElementById('detailPanel').classList.add('panel-open');
        }

        function initMap() {
            map = L.map('map').setView([20.10, -98.75], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            renderMapa();
        }

        function renderMapa() {
            markersLayer.clearLayers();
            const sidebar = document.getElementById('mapListContainer');
            sidebar.innerHTML = '<div class="p-4 bg-marino text-mostaza font-black text-center text-xs border-b-2 border-mostaza">LISTADO DE PROSPECTOS</div>';
            
            const zonas = [...new Set(allData.map(r => getVal(r, "Zona")).filter(z => z))];
            zonas.forEach(z => {
                const pros = allData.filter(r => getVal(r, "Zona") === z);
                sidebar.innerHTML += `<div class="bg-slate-100 text-marino p-2 px-4 font-black text-xs uppercase border-y flex justify-between"><span>${z}</span><span class="bg-marino text-white px-2 rounded-full">${pros.length}</span></div>`;
                pros.forEach(row => {
                    const gps = getVal(row, "GPS");
                    if(gps && gps.includes(',')) {
                        const coords = gps.split(',').map(parseFloat);
                        L.circleMarker([coords[0], coords[1]], { radius: 9, fillColor: "#ff0000", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(markersLayer);
                    }
                    sidebar.innerHTML += `<div class="p-3 px-6 border-b text-[10px] font-black uppercase hover:bg-slate-50 cursor-pointer text-slate-600" onclick="focusOnMap('${gps}', '${getVal(row, 'Nombre del negocio')}')">${getVal(row, 'Nombre del negocio')}</div>`;
                });
            });
        }

        function focusOnMap(gps, name) {
            if(gps && gps.includes(',')) {
                const coords = gps.split(',').map(parseFloat);
                map.flyTo([coords[0], coords[1]], 16);
                if(window.innerWidth <= 768) toggleMapList();
            }
        }

        function closeDetail() { document.getElementById('detailPanel').classList.remove('panel-open'); }
        window.onload = loadData;
    </script>
</body>
</html>
