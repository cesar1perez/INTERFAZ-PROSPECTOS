<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLANTERAMA CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root { --marino: #001f3f; --mostaza: #FFB800; --fondo: #f1f5f9; }
        body { font-family: sans-serif; background-color: var(--fondo); margin: 0; color: #1e293b; }
        
        .view-section { display: none; min-height: 100vh; width: 100%; }
        .active-view { display: block !important; }

        /* Estilos de botones de inicio */
        .btn-home { background: white; padding: 20px; border-radius: 15px; border-bottom: 4px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
        .btn-home:active { transform: translateY(2px); border-bottom-width: 2px; }
        
        /* Tabla mejorada para móvil */
        th { cursor: pointer; user-select: none; position: relative; }
        th:hover { background-color: #002d5c !important; }
        th::after { content: ' ↕'; font-size: 10px; opacity: 0.5; }

        #map { height: 60vh; width: 100%; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* Panel lateral sólido */
        #detailPanel { position: fixed; inset: 0; background: white; z-index: 1000; transform: translateX(100%); transition: transform 0.3s ease; }
        @media (min-width: 768px) { #detailPanel { left: auto; width: 400px; border-left: 5px solid var(--mostaza); } }
        .panel-open { transform: translateX(0) !important; }
    </style>
</head>
<body>

    <section id="homeView" class="view-section active-view bg-[#001f3f]">
        <div class="p-6 flex flex-col items-center justify-center min-h-screen text-center">
            <div class="w-20 h-20 border-4 border-[#FFB800] flex items-center justify-center text-[#FFB800] text-4xl font-black italic rounded-2xl mb-6">LL</div>
            <h1 class="text-3xl font-bold text-white mb-2 italic">PROSPECTOS</h1>
            <p class="text-[#FFB800] font-black tracking-widest text-sm mb-10">TULANCINGO - POZA RICA</p>
            
            <div class="grid grid-cols-1 gap-4 w-full max-w-sm">
                <button onclick="switchView('money')" class="btn-home">
                    <i class="fas fa-dollar-sign text-2xl text-emerald-600"></i>
                    <span class="font-bold text-marino text-sm uppercase">Comisiones Impulsores</span>
                </button>
                <button onclick="switchView('list')" class="btn-home">
                    <i class="fas fa-list text-2xl text-blue-600"></i>
                    <span class="font-bold text-marino text-sm uppercase">Listado de Clientes</span>
                </button>
                <button onclick="switchView('map')" class="btn-home">
                    <i class="fas fa-map-marker-alt text-2xl text-orange-600"></i>
                    <span class="font-bold text-marino text-sm uppercase">Mapa de Ubicaciones</span>
                </button>
            </div>
            
            <button onclick="loadData()" class="mt-12 text-white/50 text-xs font-bold uppercase"><i class="fas fa-sync mr-2"></i> Sincronizar Sistema</button>
        </div>
    </section>

    <section id="moneyView" class="view-section p-4 bg-slate-100">
        <header class="flex items-center gap-4 mb-6">
            <button onclick="switchView('home')" class="bg-white p-2 rounded-lg shadow-sm text-marino"><i class="fas fa-chevron-left"></i></button>
            <h2 class="font-black text-marino uppercase italic">Dinero Recaudado</h2>
        </header>

        <div class="space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-emerald-500">
                <p class="text-xs font-bold text-slate-400 uppercase">Marco A. Hernández</p>
                <p class="text-4xl font-black text-emerald-600 mt-1" id="pagoMarco">$0</p>
                <p class="text-[10px] font-bold text-slate-500 mt-1 uppercase" id="totalMarco">0 Prospectos</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-blue-500">
                <p class="text-xs font-bold text-slate-400 uppercase">Josue Jimárez</p>
                <p class="text-4xl font-black text-blue-600 mt-1" id="pagoJosue">$0</p>
                <p class="text-[10px] font-bold text-slate-500 mt-1 uppercase" id="totalJosue">0 Prospectos</p>
            </div>
            <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                <p class="text-xs font-medium text-amber-800 leading-tight italic">Nota: El cálculo se basa en $20 pesos por cada registro cargado en el sistema durante el trimestre Enero-Marzo.</p>
            </div>
        </div>
    </section>

    <section id="listView" class="view-section bg-white">
        <header class="p-4 bg-marino text-white flex items-center justify-between sticky top-0 z-50">
            <button onclick="switchView('home')" class="text-mostaza"><i class="fas fa-arrow-left mr-2"></i> INICIO</button>
            <span class="font-black italic text-xs">LISTADO DE CLIENTES</span>
        </header>
        
        <div class="overflow-x-auto">
            <table class="w-full text-left text-xs border-collapse">
                <thead class="bg-marino text-white uppercase font-bold">
                    <tr>
                        <th onclick="sortTable(0)" class="p-3 border-b border-white/10">Fecha</th>
                        <th onclick="sortTable(1)" class="p-3 border-b border-white/10">Negocio/Encargado</th>
                        <th onclick="sortTable(2)" class="p-3 border-b border-white/10">Estatus</th>
                        <th onclick="sortTable(3)" class="p-3 border-b border-white/10">Zona</th>
                        <th onclick="sortTable(4)" class="p-3 border-b border-white/10">Interés</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-200"></tbody>
            </table>
        </div>
    </section>

    <section id="mapView" class="view-section p-4">
        <button onclick="switchView('home')" class="mb-4 font-bold text-marino uppercase text-xs"><i class="fas fa-chevron-left mr-1"></i> Volver</button>
        <div id="map"></div>
        <div id="mapItemsContainer" class="mt-4 space-y-2 overflow-y-auto h-[30vh]"></div>
    </section>

    <div id="detailPanel">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <span class="bg-marino text-mostaza px-3 py-1 font-black italic rounded">LL</span>
                <button onclick="closeDetail()" class="text-2xl text-slate-400">&times;</button>
            </div>
            <div id="detailContent" class="flex-1 overflow-y-auto space-y-6"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcrymfUz61DDQ0fK90mTNnTqKHDwOm-UxSd9uUR6ZBjhCvcS6y2_xb7BF7uQtfIsWVsFcWAHvX-x8G/pub?gid=866211599&single=true&output=csv';
        let allData = [], map, markersLayer, markerObjects = {}, sortDirection = true;

        const zonaColores = {
            "Tulancingo": "#ef4444",
            "Poza Rica": "#3b82f6",
            "Zona Central": "#10b981",
            "Pachuca": "#f59e0b"
        };

        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view'));
            document.getElementById(v + 'View').classList.add('active-view');
            if(v === 'map' && map) setTimeout(() => map.invalidateSize(), 300);
            window.scrollTo(0,0);
        }

        function getVal(row, kw) {
            const key = Object.keys(row).find(k => k.toLowerCase().includes(kw.toLowerCase()));
            return key ? row[key] : "";
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: function(r) { 
                    allData = r.data.filter(f => f['Marca temporal']); 
                    updateCommissions();
                    render(); 
                }
            });
        }

        function updateCommissions() {
            let marco = 0, josue = 0;
            allData.forEach(row => {
                const imp = getVal(row, 'Impulsor').toLowerCase();
                if(imp.includes('marco')) marco++;
                if(imp.includes('josue')) josue++;
            });
            document.getElementById('pagoMarco').innerText = `$${marco * 20}`;
            document.getElementById('totalMarco').innerText = `${marco} PROSPECTOS`;
            document.getElementById('pagoJosue').innerText = `$${josue * 20}`;
            document.getElementById('totalJosue').innerText = `${josue} PROSPECTOS`;
        }

        function render() {
            const tbody = document.getElementById('tableBody');
            const mapItems = document.getElementById('mapItemsContainer');
            tbody.innerHTML = ''; mapItems.innerHTML = '';
            
            if(!map) {
                map = L.map('map', {zoomControl: false}).setView([20.10, -98.75], 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                markersLayer = L.layerGroup().addTo(map);
            }
            markersLayer.clearLayers();

            allData.forEach((row, i) => {
                const negocio = getVal(row, 'negocio') || "S/N";
                const encargado = getVal(row, 'encargado');
                const comp = getVal(row, 'competencia').toLowerCase().includes('si');
                const zona = getVal(row, 'Zona');
                const gps = getVal(row, 'GPS');

                tbody.innerHTML += `
                    <tr onclick="showDetail(${i})" class="active:bg-slate-100">
                        <td class="p-3 text-[9px] text-slate-400 whitespace-nowrap">${row['Marca temporal'].split(' ')[0]}</td>
                        <td class="p-3"><div class="font-bold">${negocio}</div><div class="text-[10px] text-slate-500">${encargado}</div></td>
                        <td class="p-3"><span class="font-bold ${comp ? 'text-rose-600':'text-emerald-600'}">${comp ? 'COMP':'LIBRE'}</span></td>
                        <td class="p-3 text-slate-500">${zona}</td>
                        <td class="p-3 font-bold text-marino">${getVal(row, 'interés')}</td>
                    </tr>`;

                if(gps && gps.includes(',')) {
                    const c = gps.replace(/[^\d.,-]/g, '').split(',').map(parseFloat);
                    if(!isNaN(c[0])) {
                        const color = zonaColores[zona] || "#000";
                        const m = L.circleMarker([c[0], c[1]], { radius: 7, color: 'white', fillOpacity: 1, fillColor: color }).addTo(markersLayer);
                        markerObjects[i] = m;
                        mapItems.innerHTML += `
                            <div class="bg-white p-3 rounded-lg border-l-4" style="border-left-color:${color}" onclick="zoomTo(${i})">
                                <div class="text-xs font-bold">${negocio}</div>
                                <div class="text-[10px] text-slate-400">${zona}</div>
                            </div>`;
                    }
                }
            });
        }

        function sortTable(n) {
            sortDirection = !sortDirection;
            allData.sort((a, b) => {
                let v1 = Object.values(a)[n], v2 = Object.values(b)[n];
                return sortDirection ? v1.localeCompare(v2) : v2.localeCompare(v1);
            });
            render();
        }

        function showDetail(i) {
            const r = allData[i];
            const content = document.getElementById('detailContent');
            const comp = getVal(r, 'competencia').toLowerCase().includes('si');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-2xl font-black text-marino uppercase italic leading-tight">${getVal(r, 'negocio')}</h3>
                    <div class="flex gap-2 text-[10px] font-bold">
                        <span class="bg-marino text-white px-2 py-1 rounded">ZONA: ${getVal(r, 'Zona')}</span>
                        <span class="bg-slate-100 px-2 py-1 rounded">VISTAS: ${getVal(r, 'Visitas') || 1}</span>
                    </div>

                    <div class="grid grid-cols-1 gap-2 border-t pt-4">
                        <p class="text-xs font-bold uppercase text-slate-400">Contacto</p>
                        <p class="text-sm"><b>Dueño:</b> ${getVal(r, 'encargado')}</p>
                        <p class="text-sm"><b>Tel:</b> ${getVal(r, 'Teléfono') || 'No registrado'}</p>
                        <p class="text-sm"><b>Mail:</b> ${getVal(r, 'Correo') || 'No registrado'}</p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl space-y-3">
                        <p class="text-xs font-bold uppercase text-slate-400">Líneas de Interés</p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="${getVal(r, 'acumuladores').includes('Si') ? 'font-bold text-marino' : 'text-slate-300'}">● Baterías</div>
                            <div class="${getVal(r, 'lubricante').includes('Si') ? 'font-bold text-marino' : 'text-slate-300'}">● Lubricantes</div>
                            <div class="${getVal(r, 'motobatería').includes('Si') ? 'font-bold text-marino' : 'text-slate-300'}">● Moto</div>
                            <div class="${getVal(r, 'filtros').includes('Si') ? 'font-bold text-marino' : 'text-slate-300'}">● Filtros</div>
                        </div>
                    </div>

                    <div class="p-4 ${comp ? 'bg-rose-100 text-rose-800':'bg-emerald-100 text-emerald-800'} rounded-xl text-xs font-bold">
                        <i class="fas ${comp ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i>
                        ${comp ? 'CLIENTE CON COMPETENCIA' : 'OPORTUNIDAD LIBRE (SIN COMPETENCIA)'}
                    </div>

                    <div class="bg-marino text-white p-4 rounded-xl shadow-lg">
                        <p class="text-[10px] text-mostaza font-black uppercase mb-1">Observaciones</p>
                        <p class="text-sm italic font-light leading-relaxed">"${getVal(r, 'Observaciones') || 'Sin comentarios.'}"</p>
                    </div>
                </div>
                <button onclick="switchView('map'); setTimeout(() => zoomTo(${i}), 500);" class="w-full bg-mostaza text-marino p-4 rounded-xl font-black mt-10">LOCALIZAR EN MAPA</button>
            `;
            document.getElementById('detailPanel').classList.add('panel-open');
        }

        function closeDetail() { document.getElementById('detailPanel').classList.remove('panel-open'); }
        function zoomTo(id) {
            const m = markerObjects[id];
            if(m) { map.flyTo(m.getLatLng(), 17); m.openPopup(); }
            closeDetail();
        }
        window.onload = loadData;
    </script>
</body>
</html>
