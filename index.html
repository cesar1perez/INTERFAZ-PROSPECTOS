<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLANTERAMA CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --marino: #001f3f; --mostaza: #FFB800; --fondo: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--fondo); color: #1e293b; overflow: hidden; }
        
        /* Estética Ligera */
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.2); shadow: 0 4px 30px rgba(0,0,0,0.05); }
        .view-section { display: none; height: calc(100vh - 80px); animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-view { display: flex !important; }

        /* Mapa y Sidebar */
        #map { flex-grow: 1; height: 100%; border-radius: 24px; z-index: 1; margin: 10px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .sidebar-map { width: 320px; background: transparent; display: none; flex-direction: column; padding: 10px; }
        @media (min-width: 1024px) { .sidebar-map { display: flex; } }

        /* Navegación Flotante Móvil */
        .mobile-nav { background: var(--marino); position: fixed; bottom: 20px; left: 20px; right: 20px; height: 65px; border-radius: 20px; display: flex; justify-content: space-around; align-items: center; z-index: 100; box-shadow: 0 15px 30px rgba(0,31,63,0.3); border: 2px solid var(--mostaza); }
        @media (min-width: 768px) { .mobile-nav { display: none; } }

        /* Sidebar Escritorio Slim */
        .desktop-sidebar { width: 90px; background: var(--marino); display: none; flex-direction: column; align-items: center; padding: 25px 0; border-right: 1px solid rgba(255,255,255,0.1); }
        @media (min-width: 768px) { .desktop-sidebar { display: flex; } }

        .logo-box { width: 50px; height: 50px; border: 2px solid var(--mostaza); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: var(--mostaza); font-weight: 800; italic: true; margin-bottom: 40px; }
        
        /* Scrollbar suave */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen">

    <aside class="desktop-sidebar shadow-2xl">
        <div class="logo-box">LL</div>
        <nav class="flex flex-col gap-10 mt-4">
            <button onclick="switchView('list')" class="text-white/60 hover:text-mostaza transition-all text-xl"><i class="fas fa-columns"></i></button>
            <button onclick="switchView('map')" class="text-white/60 hover:text-mostaza transition-all text-xl"><i class="fas fa-map-pin"></i></button>
            <button onclick="loadData()" class="text-white/60 hover:text-mostaza transition-all text-xl"><i class="fas fa-sync-alt"></i></button>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col relative overflow-hidden">
        
        <header class="h-20 flex items-center justify-between px-6 md:px-10">
            <div class="flex items-center gap-4">
                <div class="md:hidden logo-box !mb-0 !w-10 !h-10 text-sm">LL</div>
                <div>
                    <h2 id="viewTitle" class="text-xl font-extrabold text-slate-800 tracking-tight">Cargando...</h2>
                    <p class="text-[10px] uppercase font-bold text-slate-400 tracking-widest">Llanterama Business CRM</p>
                </div>
            </div>
            <button onclick="loadData()" class="hidden md:flex items-center gap-3 bg-white text-marino px-5 py-2.5 rounded-2xl font-bold text-xs shadow-sm hover:shadow-md transition-all border border-slate-100">
                <i class="fas fa-redo-alt text-mostaza"></i> ACTUALIZAR
            </button>
        </header>

        <div id="listView" class="view-section active-view p-4 md:p-6 overflow-hidden">
            <div class="w-full max-w-6xl mx-auto glass-card overflow-hidden flex flex-col shadow-xl">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50/50 text-slate-500 text-[10px] uppercase font-black">
                            <tr>
                                <th class="p-5">Información del Prospecto</th>
                                <th class="p-5 hidden md:table-cell">Zona</th>
                                <th class="p-5">Interés</th>
                                <th class="p-5 text-center">Visitas</th>
                                <th class="p-5">Estatus</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="mapView" class="view-section p-2">
            <div class="sidebar-map">
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 mb-4">
                    <input type="text" id="searchMap" onkeyup="filterMapList()" placeholder="Buscar cliente..." class="w-full bg-slate-50 p-3 rounded-2xl text-xs outline-none focus:ring-2 focus:ring-mostaza/30">
                </div>
                <div id="mapItemsContainer" class="space-y-3 overflow-y-auto pr-2"></div>
            </div>
            <div id="map"></div>
        </div>

        <nav class="mobile-nav">
            <button onclick="switchView('list')" class="text-white/70 flex flex-col items-center"><i class="fas fa-list-ul"></i></button>
            <button onclick="loadData()" class="bg-mostaza text-marino w-14 h-14 rounded-2xl flex items-center justify-center -mt-12 shadow-2xl border-4 border-[#001f3f]"><i class="fas fa-sync-alt text-xl"></i></button>
            <button onclick="switchView('map')" class="text-white/70 flex flex-col items-center"><i class="fas fa-map-marked-alt"></i></button>
        </nav>
    </div>

    <div id="detailPanel" class="fixed inset-y-4 right-4 w-[calc(100%-32px)] md:w-[420px] bg-white/95 backdrop-blur-xl shadow-[0_20px_50px_rgba(0,0,0,0.2)] translate-x-[110%] transition-transform duration-500 z-[200] rounded-[32px] border border-white overflow-y-auto">
        <div class="p-8">
            <div class="flex justify-between items-start mb-8">
                <div class="logo-box !w-12 !h-12 !mb-0 text-lg">LL</div>
                <button onclick="closeDetail()" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 hover:text-marino transition">&times;</button>
            </div>
            <div id="detailContent" class="space-y-8"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcrymfUz61DDQ0fK90mTNnTqKHDwOm-UxSd9uUR6ZBjhCvcS6y2_xb7BF7uQtfIsWVsFcWAHvX-x8G/pub?gid=866211599&single=true&output=csv';
        let allData = [], map, markersLayer, markerObjects = {};

        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view'));
            document.getElementById(v + 'View').classList.add('active-view');
            document.getElementById('viewTitle').innerText = v === 'list' ? 'Prospectos Recientes' : 'Mapa de Prospección';
            if(v === 'map' && map) setTimeout(() => map.invalidateSize(), 300);
        }

        function getVal(row, kw) {
            const key = Object.keys(row).find(k => k.toLowerCase().includes(kw.toLowerCase()));
            return key ? row[key] : "";
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: function(r) { 
                    allData = r.data.filter(f => f['Marca temporal']); 
                    render(); 
                }
            });
        }

        // FUNCIÓN CORREGIDA PARA EL BOTÓN LOCALIZAR
        function zoomTo(id) {
            closeDetail(); // Cerramos panel para ver el mapa
            switchView('map'); // Cambiamos a vista mapa
            
            setTimeout(() => {
                const m = markerObjects[id];
                if(m) {
                    map.flyTo(m.getLatLng(), 17, { duration: 2, easeLinearity: 0.25 });
                    setTimeout(() => m.openPopup(), 2100);
                }
            }, 500); // Pequeña espera para que el mapa se renderice
        }

        function render() {
            const tbody = document.getElementById('tableBody');
            const mapItems = document.getElementById('mapItemsContainer');
            tbody.innerHTML = ''; mapItems.innerHTML = '';
            
            if(!map) {
                map = L.map('map', {zoomControl: false}).setView([20.10, -98.75], 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                L.control.zoom({ position: 'topright' }).addTo(map);
                markersLayer = L.layerGroup().addTo(map);
            }
            markersLayer.clearLayers(); markerObjects = {};

            allData.forEach((row, i) => {
                const negocio = getVal(row, 'Nombre del negocio') || getVal(row, 'encargado') || "Sin Nombre";
                const estatus = getVal(row, 'Estatus') || 'NUEVO';
                const gps = getVal(row, 'GPS');

                tbody.innerHTML += `
                    <tr onclick="showDetail(${i})" class="hover:bg-slate-50/50 cursor-pointer transition-all">
                        <td class="p-5">
                            <div class="font-bold text-slate-800 leading-tight">${negocio}</div>
                            <div class="text-[10px] text-slate-400 font-medium">${getVal(row, 'encargado')}</div>
                        </td>
                        <td class="p-5 hidden md:table-cell text-slate-500 font-medium">${getVal(row, 'Zona')}</td>
                        <td class="p-5"><span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase ${getVal(row, 'interés').includes('Alto') ? 'bg-green-100 text-green-700':'bg-amber-100 text-amber-700'}">${getVal(row, 'interés')}</span></td>
                        <td class="p-5 text-center font-bold text-marino">${getVal(row, 'Visitas') || 1}</td>
                        <td class="p-5 text-[10px] font-extrabold text-marino tracking-tighter">${estatus}</td>
                    </tr>`;

                if(gps && gps.includes(',')) {
                    const c = gps.replace(/[^\d.,-]/g, '').split(',').map(parseFloat);
                    if(!isNaN(c[0])) {
                        const m = L.marker([c[0], c[1]]).addTo(markersLayer)
                                   .bindPopup(`<div class="font-bold text-marino text-xs uppercase">${negocio}</div>`);
                        markerObjects[i] = m;

                        mapItems.innerHTML += `
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-50 hover:border-mostaza cursor-pointer transition-all" onclick="zoomTo(${i})">
                                <div class="text-xs font-extrabold text-slate-800 uppercase">${negocio}</div>
                                <div class="text-[10px] text-slate-400">${getVal(row, 'Zona')}</div>
                            </div>`;
                    }
                }
            });
        }

        function showDetail(i) {
            const r = allData[i];
            const content = document.getElementById('detailContent');
            const icon = (v) => v && v.toLowerCase().includes('si') ? 'fa-check-circle text-green-500' : 'fa-circle text-slate-200';

            content.innerHTML = `
                <div>
                    <h4 class="text-3xl font-black text-marino leading-none mb-4 uppercase tracking-tighter">${getVal(r, 'negocio') || getVal(r, 'encargado')}</h4>
                    <div class="flex gap-2">
                        <span class="bg-marino text-mostaza px-3 py-1 text-[10px] font-black rounded-full uppercase">${getVal(r, 'Estatus') || 'NUEVO'}</span>
                        <span class="bg-slate-100 text-slate-500 px-3 py-1 text-[10px] font-black rounded-full uppercase">${getVal(r, 'Zona')}</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-5 rounded-3xl">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Visitas</p>
                        <p class="text-3xl font-black text-marino">${getVal(r, 'Visitas') || 1}</p>
                    </div>
                    <div class="bg-slate-50 p-5 rounded-3xl">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Interés</p>
                        <p class="text-xs font-bold text-marino uppercase">${getVal(r, 'interés')}</p>
                    </div>
                </div>

                <div class="space-y-3">
                    <p class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Portafolio</p>
                    <div class="grid grid-cols-1 gap-2">
                        ${['Acumuladores','Lubricantes','Motobaterías','Filtros','Llanta'].map(p => `
                            <div class="flex items-center justify-between p-4 bg-slate-50/50 rounded-2xl border border-slate-100">
                                <span class="text-sm font-bold text-slate-600">${p}</span>
                                <i class="fas ${icon(getVal(r, p))} text-lg"></i>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-marino p-6 rounded-[24px] text-white">
                    <p class="text-[9px] text-mostaza font-black uppercase mb-2 italic">Notas del Impulsor</p>
                    <p class="text-sm font-medium leading-relaxed opacity-90 italic">"${getVal(r, 'Observaciones') || 'Sin notas.'}"</p>
                </div>

                <button onclick="zoomTo(${i})" class="w-full bg-mostaza text-marino p-5 rounded-2xl font-black shadow-xl shadow-mostaza/20 hover:scale-[1.02] transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-location-arrow"></i> LOCALIZAR EN MAPA
                </button>
            `;
            document.getElementById('detailPanel').classList.remove('translate-x-[110%]');
        }

        function closeDetail() { document.getElementById('detailPanel').classList.add('translate-x-[110%]'); }
        function filterMapList() {
            let val = document.getElementById('searchMap').value.toLowerCase();
            document.querySelectorAll('#mapItemsContainer > div').forEach(item => {
                item.style.display = item.innerText.toLowerCase().includes(val) ? 'block' : 'none';
            });
        }
        window.onload = loadData;
    </script>
</body>
</html>
