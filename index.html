<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Real - Prospectos Hidalgo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .active-view { display: block !important; }
        #map { height: 600px; width: 100%; border-radius: 12px; border: 2px solid #e2e8f0; }
        .status-badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .interes-alto { background: #dcfce7; color: #166534; }
        .interes-medio { background: #fef9c3; color: #854d0e; }
        .interes-bajo { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">CRM PROSPECTOS <span class="text-blue-600">HIDALGO</span></h1>
                <p class="text-slate-500 font-medium">Control de Impulsores de Mercado</p>
            </div>
            <div class="flex gap-3 mt-4 md:mt-0">
                <button onclick="loadData()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold transition shadow-lg shadow-blue-200">
                    <i class="fas fa-sync-alt"></i> Actualizar Datos
                </button>
            </div>
        </header>

        <div class="flex gap-2 mb-6 bg-white p-1.5 rounded-2xl shadow-sm w-fit border border-slate-200">
            <button onclick="switchView('list')" id="btn-list" class="px-6 py-2.5 rounded-xl font-bold transition bg-slate-800 text-white">
                <i class="fas fa-list mr-2"></i> Lista
            </button>
            <button onclick="switchView('map')" id="btn-map" class="px-6 py-2.5 rounded-xl font-bold transition text-slate-600 hover:bg-slate-100">
                <i class="fas fa-map-marked-alt mr-2"></i> Mapa
            </button>
        </div>

        <div id="listView" class="hidden active-view">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-slate-500 text-xs uppercase tracking-widest border-b">
                                <th class="p-5 font-bold">Negocio / Encargado</th>
                                <th class="p-5 font-bold">Zona / Giro</th>
                                <th class="p-5 font-bold">Interés</th>
                                <th class="p-5 font-bold">Contacto</th>
                                <th class="p-5 font-bold">GPS</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100 text-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="mapView" class="hidden">
            <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/your-code.js" crossorigin="anonymous"></script>
    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcrymfUz61DDQ0fK90mTNnTqKHDwOm-UxSd9uUR6ZBjhCvcS6y2_xb7BF7uQtfIsWVsFcWAHvX-x8G/pub?gid=866211599&single=true&output=csv';
        
        let map, markersLayer;

        function switchView(view) {
            document.getElementById('listView').classList.toggle('hidden', view !== 'list');
            document.getElementById('mapView').classList.toggle('hidden', view !== 'map');
            
            // Estilo botones
            const isList = view === 'list';
            document.getElementById('btn-list').className = isList ? 'px-6 py-2.5 rounded-xl font-bold transition bg-slate-800 text-white' : 'px-6 py-2.5 rounded-xl font-bold transition text-slate-600 hover:bg-slate-100';
            document.getElementById('btn-map').className = !isList ? 'px-6 py-2.5 rounded-xl font-bold transition bg-slate-800 text-white' : 'px-6 py-2.5 rounded-xl font-bold transition text-slate-600 hover:bg-slate-100';

            if(view === 'map' && map) {
                setTimeout(() => map.invalidateSize(), 300);
            }
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    renderData(results.data);
                }
            });
        }

        function renderData(rawData) {
            // Filtrar solo filas con fecha (evitar vacíos)
            const data = rawData.filter(row => row['Marca temporal']);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Inicializar mapa si no existe
            if(!map) {
                map = L.map('map').setView([20.10, -98.75], 9);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                markersLayer = L.layerGroup().addTo(map);
            }
            markersLayer.clearLayers();

            data.forEach(row => {
                // MAPEADO CON TUS TÍTULOS EXACTOS
                const nombre = row['Nombre del negocio'] || 'S/N';
                const encargado = row['Nombre del encargado / Dueño'] || '-';
                const zona = row['Zona'] || '-';
                const giro = row['Giro del negocio'] || '-';
                const telefono = row['Teléfono'] || '-';
                const interes = row['¿Qué nivel de interés mostró el cliente?'] || 'Medio';
                const gps = row['Ubicación GPS (Copiar de Google Maps).'] || '';

                // Definir color de interés
                let claseInteres = 'interes-medio';
                if(interes.toLowerCase().includes('alto')) claseInteres = 'interes-alto';
                if(interes.toLowerCase().includes('bajo')) claseInteres = 'interes-bajo';

                // Insertar Fila
                tbody.innerHTML += `
                    <tr class="hover:bg-blue-50/50 transition">
                        <td class="p-5">
                            <div class="font-bold text-slate-800">${nombre}</div>
                            <div class="text-xs text-slate-400 italic">${encargado}</div>
                        </td>
                        <td class="p-5 text-sm">
                            <div class="text-slate-700">${zona}</div>
                            <div class="text-xs text-blue-500 font-medium">${giro}</div>
                        </td>
                        <td class="p-5">
                            <span class="status-badge ${claseInteres}">${interes}</span>
                        </td>
                        <td class="p-5 text-sm font-medium text-slate-600">
                            ${telefono}
                        </td>
                        <td class="p-5">
                            <span class="text-[10px] font-mono bg-slate-100 p-1 rounded text-slate-500">${gps || 'Sin GPS'}</span>
                        </td>
                    </tr>
                `;

                // Agregar al Mapa
                if(gps && gps.includes(',')) {
                    // Limpieza por si hay espacios o paréntesis
                    const coords = gps.replace(/[()]/g, '').split(',').map(c => parseFloat(c.trim()));
                    if(coords.length === 2 && !isNaN(coords[0])) {
                        const markerColor = interes.toLowerCase().includes('alto') ? 'green' : (interes.toLowerCase().includes('bajo') ? 'red' : 'orange');
                        
                        L.marker([coords[0], coords[1]]).addTo(markersLayer)
                            .bindPopup(`
                                <div style="font-family: sans-serif">
                                    <b style="font-size:14px">${nombre}</b><br>
                                    <small>${zona}</small><br>
                                    <hr style="margin:5px 0">
                                    <b>Interés:</b> ${interes}<br>
                                    <b>Giro:</b> ${giro}
                                </div>
                            `);
                    }
                }
            });

            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-20 text-center text-slate-400">Sin registros encontrados.</td></tr>';
            }
        }

        // Cargar al iniciar
        window.onload = loadData;
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</body>
</html>
